{% extends "base.html" %}
{% block content %}
<section class="card device-container">
  <div class="tabs">
    <button class="tab active" data-tab="overview">–û–±–∑–æ—Ä</button>
    <button class="tab" data-tab="interfaces">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã</button>
    <button class="tab" data-tab="routing">–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è</button>
    <button class="tab" data-tab="vlans">VLAN</button>
    <button class="tab" data-tab="arp">ARP</button>
    <button class="tab" data-tab="logs">–õ–æ–≥–∏</button>
  </div>

  <div id="panel-overview" class="tab-panel active">
    <div id="overview"></div>
  </div>
  <div id="panel-interfaces" class="tab-panel">
    <div id="interfaces"></div>
    <div class="iface-tools" style="display:flex; gap:15px; margin:15px 0;">
    <input id="ifaceSearch" placeholder="–ü–æ–∏—Å–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤..." 
           style="width:220px;padding:8px 10px;border-radius:10px">

    <select id="bulkVlan" style="width:120px">
        <option value="">VLAN...</option>
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="30">30</option>
    </select>

    <button class="btn btn-primary" id="applyBulkVlan">–ü—Ä–∏–º–µ–Ω–∏—Ç—å VLAN</button>
</div>


    <div class="actions">
    <button id="editInterfacesBtn" class="btn btn-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    <button id="saveInterfaces" class="btn btn-success" style="display:none">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button id="cancelEdit" class="btn btn-ghost" style="display:none">–û—Ç–º–µ–Ω–∞</button>
</div>
  </div>
  <div id="panel-routing" class="tab-panel">
    <div id="routing"></div>
  </div>
  <div id="panel-vlans" class="tab-panel">
    <div class="actions">
        <button id="editVlansBtn" class="btn btn-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="addVlanBtn" class="btn btn-success" style="display:none">–î–æ–±–∞–≤–∏—Ç—å VLAN</button>
        <button id="saveVlansBtn" class="btn btn-success" style="display:none">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="cancelVlansBtn" class="btn btn-ghost" style="display:none">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <div id="vlans"></div>
</div>
  <div id="panel-arp" class="tab-panel">
    <div id="arp"></div>
  </div>
  <div id="panel-logs" class="tab-panel">
    <div class="filters">
      <label>–£—Ä–æ–≤–µ–Ω—å
        <select id="logLevel">
          <option value="">–í—Å–µ</option>
          <option value="DEBUG">DEBUG</option>
          <option value="INFO">INFO</option>
          <option value="WARN">WARN</option>
          <option value="ERROR">ERROR</option>
          <option value="CRITICAL">CRITICAL</option>
        </select>
      </label>
      <label>–°
        <input type="datetime-local" id="since" />
      </label>
      <label>–ü–æ
        <input type="datetime-local" id="until" />
      </label>
      <button id="applyLogs" class="btn btn-ghost">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <div id="logs"></div>
  </div>
</section>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

  let currentSort = { col: null, asc: true };

function sortBy(col) {
    if (currentSort.col === col) {
        currentSort.asc = !currentSort.asc;
    } else {
        currentSort.col = col;
        currentSort.asc = true;
    }

    IFACE_CACHE.sort((a, b) => {
        let A = (a[col] ?? "").toString().toLowerCase();
        let B = (b[col] ?? "").toString().toLowerCase();
        if (A < B) return currentSort.asc ? -1 : 1;
        if (A > B) return currentSort.asc ? 1 : -1;
        return 0;
    });

    renderInterfaces(IFACE_CACHE);
}


const DEVICE_ID = "{{ device_id }}";
// Tabs
document.querySelectorAll(".tab").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".tab-panel").forEach(p=>p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById("panel-"+btn.dataset.tab).classList.add("active");
  });
});

async function loadDevice() {
  const res = await fetch(`/api/device/${DEVICE_ID}`);
  if (!res.ok) { alert("–ù–µ –Ω–∞–π–¥–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ"); return; }
  const {device} = await res.json();
  renderOverview(device);
  renderInterfaces(device.interfaces || []);
  renderRouting(device.routing || []);
  renderVlans(device.vlans || []);
  renderLLDP(device.lldp || []);
  renderArp(device.arp || []);
  await loadLogs();
}

function renderOverview(d){
  const el = document.getElementById("overview");
  el.innerHTML = `
  <div class="kv">
      <div><span>Hostname</span><b>${d.hostname}</b></div>
      <div><span>IP</span><b>${d.management_ip}</b></div>
      <div><span>–í–µ–Ω–¥–æ—Ä</span><b>${d.vendor}</b></div>
      <div><span>–ú–æ–¥–µ–ª—å</span><b>${d.model || "-"}</b></div>
      <div><span>–û–°</span><b>${d.os || "N/A"}</b></div>
      <div><span>Uptime</span><b>${d.uptime || "-"}</b></div>
      <div><span>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</span><b>${d.temperature || "-"}</b></div>
      <div><span>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–±—É—Ç</span><b>${d.last_reboot || "-"}</b></div>
      <div><span>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</span><b>${d.serial || "-"}</b></div>

      <div><span>–õ–æ–∫–∞—Ü–∏—è</span>
          <input id="editLocation" value="${d.location || ""}">
      </div>
      <div><span>–ó–∞–º–µ—Ç–∫–∏</span>
          <input id="editNotes" value="${d.notes || ""}">
      </div>
  </div>

  <div class="actions" style="margin-top:10px;margin-bottom:25px">
      <button class="btn btn-primary" onclick="saveMeta()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>

  <hr style="opacity:.2;margin:20px 0">

  <h3>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</h3>
  <div class="charts-row">
      <canvas id="chartCpu"></canvas>
      <canvas id="chartMem"></canvas>
  </div>
  <div class="charts-row">
    <canvas id="chartTemp"></canvas>
    <canvas id="chartTraffic"></canvas>
</div>

  <hr style="opacity:.2;margin:20px 0">

  <h3>–°–≤–æ–¥–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤</h3>
  <table class="table">
      <thead>
          <tr><th>–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</th><th>IP</th><th>–°—Ç–∞—Ç—É—Å</th><th>–¢—Ä–∞—Ñ–∏–∫</th></tr>
      </thead>
      <tbody>
      ${
        (d.interfaces || []).slice(0,5).map(iface => `
          <tr>
              <td>${iface.name}</td>
              <td>${iface.ip || "-"}</td>
              <td>${iface.status === "up" ? "<span style='color:#4dffa3'>UP</span>" : "<span style='color:#ff6b6b'>DOWN</span>"}</td>
              <td>${iface.traffic || "-"}</td>
          </tr>
        `).join("")
      }
      </tbody>
  </table>

  <hr style="opacity:.2;margin:20px 0">

  <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏</h3>
  <ul>
    ${
      (d.logs || []).slice(0,5).map(l => 
        `<li style="opacity:.7;margin-bottom:4px">${l}</li>`
      ).join("")
    }
  </ul>

    <hr style="opacity:.2;margin:20px 0">

  <h3>–°–æ—Å–µ–¥–∏ (LLDP)</h3>
  <div id="lldpMap" class="lldp-map"></div>

  <hr style="opacity:.2;margin:20px 0">

  <h3>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>
  <div class="actions">
      <button class="btn btn-primary" onclick="runPing('${d.management_ip}')">Ping</button>
      <button class="btn btn-primary" onclick="runTrace('${d.management_ip}','${d.hostname}')">Traceroute</button>
  </div>

  <pre id="diagOutput" style="background:#0c132e;padding:12px;border-radius:12px;margin-top:12px;display:none"></pre>
  `;

  setTimeout(()=>initCharts(),50);
}

function renderLLDP(neigh){
    const box = document.getElementById("lldpMap");

    // –ï—Å–ª–∏ –Ω–µ—Ç LLDP –¥–∞–Ω–Ω—ã—Ö
    if (!neigh || neigh.length === 0){
        box.innerHTML = `<p class="muted">–ù–µ—Ç LLDP —Å–æ—Å–µ–¥–µ–π</p>`;
        return;
    }

    // –ü—Ä–∏–≤–æ–¥–∏–º —Ç–≤–æ—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫ —Ä–∞–±–æ—á–µ–π
    const norm = neigh.map(n => ({
        hostname: n.hostname || n.neighbor_id || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",
        vendor: n.vendor || "-",
        model: n.model || "-",
        local_port: n.local_port || n.local_iface || "‚Äî",
        remote_port: n.remote_port || n.neighbor_iface || "‚Äî",
        type: n.type || "switch"
    }));

    box.innerHTML = `
        <div class="lldp-grid">
            ${norm.map(n => `
                <div class="lldp-card">
                    <div class="lldp-title">
                        <span class="dot ${n.type}"></span> ${n.hostname}
                    </div>

                    <div class="lldp-row"><span>–í–µ–Ω–¥–æ—Ä:</span> ${n.vendor}</div>
                    <div class="lldp-row"><span>–ú–æ–¥–µ–ª—å:</span> ${n.model}</div>

                    <div class="lldp-row"><span>–õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç:</span> ${n.local_port}</div>
                    <div class="lldp-row"><span>–£–¥–∞–ª—ë–Ω–Ω—ã–π –ø–æ—Ä—Ç:</span> ${n.remote_port}</div>

                    <div class="lldp-link-line"></div>
                </div>
            `).join("")}
        </div>
    `;
}



function initCharts(){
  makeChart("chartCpu", "CPU %", [23,25,33,50,44,41,39]);
  makeChart("chartMem", "Memory %", [55,56,58,61,62,59,57]);
  makeChart("chartTemp", "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ¬∞C", [47,48,49,47,52,50,51], "#ffb36b");
  makeChart("chartTraffic", "–¢—Ä–∞—Ñ–∏–∫ Mbps", [10,14,18,23,20,30,27], "#3bf59f");
}

function makeChart(id, label, data, color="#4f6bff"){
  const ctx = document.getElementById(id).getContext("2d");
  ctx.canvas.width = 400;
  ctx.canvas.height = 250;
  new Chart(document.getElementById(id), {
      type: "line",
      data: {
          labels: [...Array(data.length).keys()],
          datasets: [{
              label,
              data,
              borderColor: color,
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.35
          }]
      },
      options: {
          plugins: { legend: { labels: { color:"#9aa4c7" }}},
          scales: {
              x: { ticks:{color:"#7d89b5"} },
              y: { ticks:{color:"#7d89b5"} }
          }
      }
  });
}

function runPing(ip){
  const out = document.getElementById("diagOutput");
  out.style.display = "block";
  out.textContent = `Pinging ${ip}...

Reply from ${ip}: time=2 ms
Reply from ${ip}: time=3 ms
Reply from ${ip}: time=1 ms

Ping complete.`;
}

function runTrace(ip,host){
  const out = document.getElementById("diagOutput");
  out.style.display = "block";
  out.textContent = `Traceroute to ${ip}:

1  core-r1        10.0.0.1
2  dist-sw2       10.0.1.2
3  ${host}        ${ip}

Done.`;
}


let IFACE_EDIT_MODE = false; // —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
let IFACE_CACHE = [];        // –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

function renderInterfaces(ifaces) {
    IFACE_CACHE = JSON.parse(JSON.stringify(ifaces)); // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª
    const el = document.getElementById("interfaces");

    function getIcon(iface) {
        const n = iface.name.toLowerCase();
        if (n.startsWith("te") || n.startsWith("xe") || n.startsWith("et")) return "üî∑";
        if (n.startsWith("gi") || n.startsWith("fa") || n.startsWith("e")) return "üîå";
        if (n.startsWith("lo") || n.startsWith("vl")) return "üåê";
        return "üîó";
    }

    function renderRow(it) {
        // —Ä–µ–∂–∏–º –ü–†–û–°–ú–û–¢–†–ê
        if (!IFACE_EDIT_MODE) {
            return `
            <tr>
                <td>${getIcon(it)} ${it.name}</td>
                <td>${it.ip || "-"}</td>
                <td>${it.vlan || "-"}</td>
                <td>${it.speed || "-"}</td>
                <td>${it.status==="up" ? "<span class='iface-status up'>UP</span>":"<span class='iface-status down'>DOWN</span>"}</td>
                <td>${it.errors ?? 0}</td>
                <td>${it.crc ?? 0}</td>
                <td>${it.traffic || "‚Äî"}</td>
                <td>‚Äî</td>
                <td>${it.admin_status}</td>
            </tr>
            `;
        }

        // —Ä–µ–∂–∏–º –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø
        return `
<tr class="${it.status === 'down' ? 'iface-down-row' : ''}">  
            <td>${getIcon(it)} ${it.name}</td>

            <td><input class="iface-edit" data-key="ip" value="${it.ip||""}"></td>
            <td><input class="iface-edit small" data-key="vlan" value="${it.vlan||""}"></td>
            <td><input class="iface-edit small" data-key="speed" value="${it.speed||""}"></td>

            <td>
                <select class="iface-edit" data-key="status">
                    <option value="up"   ${it.status==="up"?"selected":""}>UP</option>
                    <option value="down" ${it.status==="down"?"selected":""}>DOWN</option>
                </select>
            </td>

            <td class="${(it.errors > 0 || it.crc > 0) ? 'iface-errors-bad' : 'iface-errors-ok'}">${it.errors ?? 0}</td>
            <td class="${(it.errors > 0 || it.crc > 0) ? 'iface-errors-bad' : 'iface-errors-ok'}">${it.crc ?? 0}</td>

            <td>${it.traffic || "‚Äî"}</td>
            <td>‚Äî</td>

            <td>
                <select class="iface-edit" data-key="admin_status">
                    <option value="up"   ${it.admin_status==="up"?"selected":""}>up</option>
                    <option value="down" ${it.admin_status==="down"?"selected":""}>down</option>
                </select>
            </td>
        </tr>
        `;
    }

    let html = `
    <table class="table">
        <thead>
<tr>
    <th onclick="sortBy('name')" style="cursor:pointer">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</th>
    <th onclick="sortBy('ip')" style="cursor:pointer">IP</th>
    <th onclick="sortBy('vlan')" style="cursor:pointer">VLAN</th>
    <th onclick="sortBy('speed')" style="cursor:pointer">–°–∫–æ—Ä–æ—Å—Ç—å</th>
    <th onclick="sortBy('status')" style="cursor:pointer">–°—Ç–∞—Ç—É—Å</th>
    <th>–û—à–∏–±–∫–∏</th>
    <th>CRC</th>
    <th>–¢—Ä–∞—Ñ–∏–∫</th>
    <th>–ì—Ä–∞—Ñ–∏–∫</th>
    <th>–ê–¥–º–∏–Ω</th>
</tr>
</thead>
        <tbody>
            ${ifaces.map(renderRow).join("")}
        </tbody>
    </table>
    `;

    el.innerHTML = html;
}

// –ö–Ω–æ–ø–∫–∞ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
document.getElementById("editInterfacesBtn").onclick = () => {
    IFACE_EDIT_MODE = true;
    renderInterfaces(IFACE_CACHE);

    document.getElementById("saveInterfaces").style.display = "inline-block";
    document.getElementById("cancelEdit").style.display = "inline-block";
    document.getElementById("editInterfacesBtn").style.display = "none";
};

// –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∞"
document.getElementById("cancelEdit").onclick = () => {
    IFACE_EDIT_MODE = false;
    renderInterfaces(IFACE_CACHE);

    document.getElementById("saveInterfaces").style.display = "none";
    document.getElementById("cancelEdit").style.display = "none";
    document.getElementById("editInterfacesBtn").style.display = "inline-block";
};

// –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
document.getElementById("saveInterfaces").onclick = async () => {
    const rows = [...document.querySelectorAll("#interfaces tbody tr")];
    const updated = rows.map(row => {
        const name = row.dataset.name;
        const item = IFACE_CACHE.find(x => x.name === name);

        row.querySelectorAll(".iface-edit").forEach(inp => {
            item[inp.dataset.key] = inp.value;
        });

        return item;
    });

    const res = await fetch(`/api/device/${DEVICE_ID}/interfaces`, {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ interfaces: updated })
    });

    const data = await res.json();

    if (data.ok) {
        alert("–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
        IFACE_EDIT_MODE = false;
        renderInterfaces(updated);
    } else {
        alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
    }

    document.getElementById("saveInterfaces").style.display = "none";
    document.getElementById("cancelEdit").style.display = "none";
    document.getElementById("editInterfacesBtn").style.display = "inline-block";
};


function renderRouting(routes) {
    const el = document.getElementById("routing");
    el.innerHTML = "";

    // –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º
    const groups = {
        connected: [],
        static: [],
        ospf: [],
        bgp: [],
        other: []
    };

    routes.forEach(r => {
        const proto = (r.proto || "").toLowerCase();
        if (groups[proto]) groups[proto].push(r);
        else groups.other.push(r);
    });

    // —Ä–µ–Ω–¥–µ—Ä
    for (const proto in groups) {
        if (groups[proto].length === 0) continue;

        const block = document.createElement("div");
        block.className = "route-group";

        const title = proto.toUpperCase();
        const icon = {
            connected: "üü¢",
            static: "üü¶",
            ospf: "üü°",
            bgp: "üî¥",
            other: "‚ö™"
        }[proto];

        block.innerHTML = `
        <h3 class="route-title">${icon} ${title}</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>–°–µ—Ç—å</th>
                    <th>Next Hop</th>
                    <th>–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</th>
                    <th>–ú–µ—Ç—Ä–∏–∫–∞</th>
                    <th>–ü—Ä–æ—Ç–æ–∫–æ–ª</th>
                    <th>–û–ø–µ—Ä–∞—Ü–∏–∏</th>
                </tr>
            </thead>
            <tbody>
                ${groups[proto].map(r => `
                    <tr>
                        <td>${r.prefix}</td>
                        <td>${r.nexthop || "-"}</td>
                        <td>${r.iface || "-"}</td>
                        <td>${r.metric || "-"}</td>
                        <td>${r.proto}</td>
                        <td>
                            <button class="btn btn-ghost small" onclick="traceRoute('${r.prefix}')">Traceroute</button>
                            ${r.proto === "static" ? `
                                <button class="btn btn-primary small" onclick="editRoute('${r.prefix}')">Edit</button>
                            ` : ""}
                        </td>
                    </tr>
                `).join("")}
            </tbody>
        </table>
        `;

        el.appendChild(block);
    }
}

let VLAN_EDIT_MODE = false;
let VLAN_CACHE = [];

// =======================
//   –†–ï–ù–î–ï–† VLAN
// =======================
function renderVlans(vlans) {
    VLAN_CACHE = JSON.parse(JSON.stringify(vlans)); // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ø–∏—é
    const el = document.getElementById("vlans");

    if (!VLAN_EDIT_MODE) {
        // ===== –ü–†–û–°–ú–û–¢–† =====
        el.innerHTML = `
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ò–º—è</th>
                        <th>–¢–∏–ø</th>
                        <th>–ü–æ—Ä—Ç—ã</th>
                    </tr>
                </thead>
                <tbody>
                    ${vlans.map(v => `
                        <tr>
                            <td>${v.id}</td>
                            <td>${v.name}</td>
                            <td>${v.type}</td>
                            <td>${(v.ports || []).join(", ")}</td>
                        </tr>
                    `).join("")}
                </tbody>
            </table>
        `;
        return;
    }

    // ===== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï =====
    el.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ò–º—è</th>
                    <th>–¢–∏–ø</th>
                    <th>–ü–æ—Ä—Ç—ã</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                ${vlans.map(v => `
                    <tr data-id="${v.id}">
                        <td><input class="vlan-edit small" data-key="id" value="${v.id}"></td>
                        <td><input class="vlan-edit" data-key="name" value="${v.name}"></td>
                        <td>
                            <select class="vlan-edit" data-key="type">
                                <option value="access" ${v.type==="access"?"selected":""}>access</option>
                                <option value="trunk" ${v.type==="trunk"?"selected":""}>trunk</option>
                            </select>
                        </td>
                        <td><input class="vlan-edit" data-key="ports" value="${(v.ports||[]).join(", ")}"></td>
                        <td>
                            <button class="btn btn-ghost small" onclick="deleteVlan('${v.id}')">üóë</button>
                        </td>
                    </tr>
                `).join("")}
            </tbody>
        </table>
    `;
}

// =======================
//   –î–û–ë–ê–í–ò–¢–¨ VLAN
// =======================
document.getElementById("addVlanBtn").onclick = () => {
    VLAN_CACHE.push({
        id: "",
        name: "",
        type: "access",
        ports: []
    });
    renderVlans(VLAN_CACHE);
};

// =======================
//   –£–î–ê–õ–ò–¢–¨ VLAN
// =======================
function deleteVlan(id) {
    VLAN_CACHE = VLAN_CACHE.filter(v => String(v.id) !== String(id));
    renderVlans(VLAN_CACHE);
}


// =======================
//   –ö–ù–û–ü–ö–ê ‚Äî –†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨
// =======================
document.getElementById("editVlansBtn").onclick = () => {
    VLAN_EDIT_MODE = true;
    renderVlans(VLAN_CACHE);

    document.getElementById("editVlansBtn").style.display = "none";
    document.getElementById("addVlanBtn").style.display = "inline-block";
    document.getElementById("saveVlansBtn").style.display = "inline-block";
    document.getElementById("cancelVlansBtn").style.display = "inline-block";
};


// =======================
//   –ö–ù–û–ü–ö–ê ‚Äî –û–¢–ú–ï–ù–ê
// =======================
document.getElementById("cancelVlansBtn").onclick = () => {
    VLAN_EDIT_MODE = false;
    renderVlans(VLAN_CACHE);

    document.getElementById("editVlansBtn").style.display = "inline-block";
    document.getElementById("addVlanBtn").style.display = "none";
    document.getElementById("saveVlansBtn").style.display = "none";
    document.getElementById("cancelVlansBtn").style.display = "none";
};


// =======================
//   –ö–ù–û–ü–ö–ê ‚Äî –°–û–•–†–ê–ù–ò–¢–¨
// =======================
document.getElementById("saveVlansBtn").onclick = async () => {
    const rows = [...document.querySelectorAll("#vlans tbody tr")];

    const updated = rows.map(row => {
        let obj = {};
        row.querySelectorAll(".vlan-edit").forEach(inp => {
            let k = inp.dataset.key;
            let val = inp.value.trim();

            if (k === "ports") {
                obj[k] = val ? val.split(",").map(s => s.trim()) : [];
            } else if (k === "id") {
                obj[k] = parseInt(val);
            } else {
                obj[k] = val;
            }
        });
        return obj;
    });

    const res = await fetch(`/api/device/${DEVICE_ID}/vlans`, {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({vlans: updated})
    });

    const data = await res.json();

    if (data.ok) {
        alert("VLAN —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
        VLAN_EDIT_MODE = false;
        renderVlans(updated);
    } else {
        alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
    }

    document.getElementById("editVlansBtn").style.display = "inline-block";
    document.getElementById("addVlanBtn").style.display = "none";
    document.getElementById("saveVlansBtn").style.display = "none";
    document.getElementById("cancelVlansBtn").style.display = "none";
};


function renderVlans(vlans) {
    const el = document.getElementById("vlans");

    if (!vlans || vlans.length === 0) {
        el.innerHTML = `<p class="muted">–ù–µ—Ç VLAN –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</p>`;
        return;
    }

    el.innerHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ò–º—è</th>
                    <th>–¢–∏–ø</th>
                    <th>–ü–æ—Ä—Ç—ã</th>
                </tr>
            </thead>
            <tbody>
                ${vlans.map(v => `
                    <tr>
                        <td>${v.id}</td>
                        <td>${v.name}</td>
                        <td>${v.type}</td>
                        <td>${Array.isArray(v.ports) ? v.ports.join(", ") : "-"}</td>
                    </tr>
                `).join("")}
            </tbody>
        </table>
    `;
}


// –º–æ–∫-—Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞
function traceRoute(prefix) {
    const out = document.getElementById("diagOutput") || createDiagBox();
    out.style.display = "block";

    out.textContent = `
–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –¥–æ ${prefix}...

1   Access-1      10.0.1.1
2   Dist-1        10.0.0.2
3   Core-1        10.0.0.1
4   ${prefix}

Done.
    `;
}

// –æ–∫–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏, –µ—Å–ª–∏ –Ω–µ—Ç
function createDiagBox(){
    const box = document.createElement("pre");
    box.id = "diagOutput";
    box.style.cssText = "background:#0c132e;padding:12px;border-radius:12px;margin-top:12px;";
    document.getElementById("routing").appendChild(box);
    return box;
}

// —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
function editRoute(prefix){
    alert("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ static route: " + prefix + "\n(–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É)");
}


function renderArp(entries){
  const el = document.getElementById("arp");
  const table = document.createElement("table");
  table.className = "table";
  table.innerHTML = `<thead><tr><th>IP</th><th>MAC</th><th>–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</th><th>–í—Ä–µ–º—è</th></tr></thead>`;
  const tbody = document.createElement("tbody");
  for (const a of entries){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${a.ip}</td><td>${a.mac}</td><td>${a.iface}</td><td>${a.age||"-"}</td>`;
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  el.innerHTML = "";
  el.appendChild(table);
}

async function loadLogs(){
  const params = new URLSearchParams();
  const level = document.getElementById("logLevel").value;
  const since = document.getElementById("since").value;
  const until = document.getElementById("until").value;
  if (level) params.append("level", level);
  if (since) params.append("since", new Date(since).toISOString());
  if (until) params.append("until", new Date(until).toISOString());
  const res = await fetch(`/api/device/${DEVICE_ID}/logs?`+params.toString());
  const {logs} = await res.json();
  const el = document.getElementById("logs");
  const table = document.createElement("table");
  table.className = "table";
  table.innerHTML = `<thead><tr><th>–í—Ä–µ–º—è</th><th>–£—Ä–æ–≤–µ–Ω—å</th><th>–°–æ–æ–±—â–µ–Ω–∏–µ</th></tr></thead>`;
  const tbody = document.createElement("tbody");
  for (const l of logs){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${l.time}</td><td>${l.level}</td><td>${l.msg}</td>`;
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  el.innerHTML = "";
  el.appendChild(table);
}
document.getElementById("applyLogs").addEventListener("click", loadLogs);

async function saveMeta(){
  const location = document.getElementById("editLocation").value;
  const notes = document.getElementById("editNotes").value;
  const res = await fetch(`/api/device/${DEVICE_ID}/meta`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({location, notes})
  });
  const data = await res.json();
  if (data.ok) alert("–û–±–Ω–æ–≤–ª–µ–Ω–æ");
  else alert(data.error || "–û—à–∏–±–∫–∞");
}

document.getElementById("logoutBtn")?.addEventListener("click", async ()=>{
  await fetch("/api/logout",{method:"POST"});
  window.location="/login";
});

document.getElementById("ifaceSearch").oninput = (e) => {
    const q = e.target.value.toLowerCase();

    const filtered = IFACE_CACHE.filter(i =>
        i.name.toLowerCase().includes(q) ||
        (i.ip ?? "").toLowerCase().includes(q) ||
        (i.vlan ?? "").toString().includes(q)
    );

    renderInterfaces(filtered);
};

document.getElementById("applyBulkVlan").onclick = () => {
    const val = document.getElementById("bulkVlan").value;
    if (!val) return alert("–í—ã–±–µ—Ä–∏—Ç–µ VLAN");

    IFACE_CACHE.forEach(i => {
        i.vlan = val;
    });

    renderInterfaces(IFACE_CACHE);
};

loadDevice();
</script>
{% endblock %}
